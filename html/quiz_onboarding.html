<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quiz Onboarding - Eurocast</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root {
      --c-primary:#b31217;
      --c-primary-alt:#e53935;
      --c-accent:#ff5252;
      --c-bg:#f5f7fa;
      --c-surface:#ffffff;
      --c-border:#e2e6eb;
      --c-text:#333;
      --c-text-light:#56606d;
      --radius:18px;
      --gradient:linear-gradient(135deg,var(--c-primary-alt),var(--c-primary));
    }
    body {margin:0;font-family:'Segoe UI',system-ui,sans-serif;background:var(--c-bg);color:var(--c-text);}    
    header {background:var(--gradient);color:#fff;padding:24px 30px;box-shadow:0 8px 24px rgba(0,0,0,.18);}  
    header .inner {max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:20px;}
    header h1 {margin:0;font-size:1.7rem;letter-spacing:.5px;}
    main {max-width:1100px;margin:0 auto;padding:40px 20px 120px;}

    .quiz-intro {background:var(--c-surface);border:1px solid var(--c-border);padding:26px 30px;border-radius:20px;box-shadow:0 4px 14px rgba(0,0,0,.05);margin-bottom:36px;}
    .quiz-intro h2 {margin:0 0 10px;font-size:1.35rem;color:var(--c-primary);}  
    .quiz-intro p {margin:0 0 10px;font-size:.9rem;line-height:1.5;color:var(--c-text-light);}  

    #quizContainer {background:var(--c-surface);border:1px solid var(--c-border);border-radius:24px;padding:34px 38px;box-shadow:0 4px 18px rgba(0,0,0,.06);position:relative;}
    #questionHeader {display:flex;justify-content:space-between;align-items:center;gap:20px;flex-wrap:wrap;margin-bottom:18px;}
    #questionHeader h2 {margin:0;font-size:1.15rem;color:var(--c-primary);}  
    #progressOuter {flex:1;height:10px;background:#eceff2;border-radius:40px;overflow:hidden;position:relative;}
    #progressInner {position:absolute;inset:0;width:0%;background:var(--gradient);transition:width .45s ease;}

    .answers {display:flex;flex-direction:column;gap:12px;margin:20px 0 10px;}
    .answer-btn {text-align:left;background:#fff;border:1px solid #d9dde2;padding:14px 16px;font-size:.85rem;line-height:1.35;border-radius:12px;cursor:pointer;font-weight:600;letter-spacing:.3px;display:flex;gap:10px;align-items:flex-start;position:relative;transition:.2s;}
    .answer-btn:hover {background:#f9fafb;border-color:#cdd2d8;}
    .answer-btn:focus-visible {outline:3px solid #b31217;outline-offset:2px;}
  /* Mode sans correction imm√©diate */
  .answer-btn.active {border-color:var(--c-primary);background:#fff8f8;box-shadow:0 0 0 2px rgba(179,18,23,.18);} 

    .nav-actions {display:flex;justify-content:space-between;align-items:center;margin-top:24px;gap:14px;flex-wrap:wrap;}
    .btn {appearance:none;border:none;cursor:pointer;font-family:inherit;font-weight:600;letter-spacing:.5px;font-size:.78rem;display:inline-flex;align-items:center;gap:8px;border-radius:12px;padding:13px 18px;transition:.2s;}
    .btn-primary {background:var(--gradient);color:#fff;box-shadow:0 4px 14px rgba(179,18,23,.25);border:1px solid #b31217;}
    .btn-primary:hover {filter:brightness(1.06);transform:translateY(-2px);}  
    .btn-secondary {background:#ffffff;border:1px solid #d4d9de;color:#374151;}
    .btn-secondary:hover {background:#f3f5f7;}  

    .badge {display:inline-block;background:#b31217;color:#fff;font-size:.6rem;font-weight:700;padding:4px 8px;border-radius:6px;letter-spacing:.5px;}
  .timer {font-size:.7rem;font-weight:700;letter-spacing:.5px;background:#fff;border:1px solid #dcdfe3;padding:6px 10px;border-radius:40px;display:inline-flex;align-items:center;gap:6px;}
  .timer.warning {background:#fff4e5;border-color:#f7b14b;color:#9a5a00;}
  .timer.danger {background:#ffe9e9;border-color:#e53935;color:#b31217;animation:pulseTime 1s infinite alternate;}
  @keyframes pulseTime {from {transform:scale(1);} to {transform:scale(1.07);} }

    #feedback {margin-top:14px;font-size:.78rem;font-weight:600;letter-spacing:.3px;}
    #feedback span {padding:4px 8px;border-radius:6px;}
    #feedback .good {background:#22a354;color:#fff;}  
    #feedback .bad {background:#e53935;color:#fff;}

    /* Certificat */
    #certificateModal {display:none;position:fixed;inset:0;z-index:9999;align-items:flex-start;justify-content:center;padding:60px 20px;background:rgba(0,0,0,.5);}  
    #certificateModal.active {display:flex;}
    .cert-dialog {background:#fff;max-width:780px;width:100%;border-radius:28px;padding:40px 46px;box-shadow:0 20px 60px rgba(0,0,0,.25);position:relative;}
    .cert-dialog h2 {margin:0 0 12px;font-size:1.6rem;color:var(--c-primary);}  
    .cert-dialog p {margin:0 0 18px;font-size:.9rem;line-height:1.5;}
    .cert-body {border:2px dashed #dcdfe3;border-radius:16px;padding:26px 28px;margin:18px 0;background:linear-gradient(135deg,#ffffff,#fafbfc);}  
    .cert-title {font-size:1.3rem;font-weight:700;margin:0 0 6px;color:#b31217;}  
    .cert-meta {font-size:.7rem;letter-spacing:.5px;color:#5a626d;margin-bottom:14px;}
    .cert-emblem {position:absolute;right:40px;top:46px;font-size:3.2rem;opacity:.12;}
  .close-cert {position:absolute;top:14px;right:14px;background:transparent;border:none;font-size:1.3rem;cursor:pointer;z-index:20;line-height:1;}
  .close-cert:focus-visible {outline:3px solid var(--c-primary);border-radius:8px;}

    .download-btn {background:var(--gradient);color:#fff;border:1px solid #b31217;padding:12px 18px;display:inline-flex;align-items:center;gap:8px;border-radius:14px;font-weight:600;letter-spacing:.5px;cursor:pointer;box-shadow:0 4px 14px rgba(179,18,23,.25);}
    .download-btn:hover {filter:brightness(1.06);transform:translateY(-2px);}  

    footer {margin-top:80px;font-size:.6rem;text-align:center;color:#6c7680;}
  </style>
</head>
<body>
  <header>
    <div class="inner"><h1>Quiz Final Onboarding</h1><div class="badge">Certification</div></div>
  </header>
  <main>
    <div class="quiz-intro">
      <h2>üéì Evaluation finale</h2>
      <p>R√©pondez aux questions pour valider votre compr√©hension des th√®mes: s√©curit√©, GLPI, mat√©riel, donn√©es, usage acceptable, support.</p>
      <p>Score requis: <strong>70%</strong>. Une fois r√©ussi, vous pourrez g√©n√©rer et t√©l√©charger votre certificat.</p>
    </div>

    <div id="quizContainer" aria-live="polite">
      <div id="questionHeader">
        <h2 id="questionTitle">Question</h2>
        <div id="progressOuter"><div id="progressInner"></div></div>
        <div class="timer" id="timer" title="Chrono">‚è± <span id="time">00:00</span></div>
      </div>
      <div id="questionText" style="font-size:.92rem;line-height:1.5;color:#374151;"></div>
      <div class="answers" id="answers"></div>
  <div id="feedback" style="min-height:0"></div>
      <div class="nav-actions">
        <button class="btn btn-secondary" id="prevBtn" disabled>‚óÄ Pr√©c√©dent</button>
        <div style="flex:1"></div>
        <button class="btn btn-primary" id="nextBtn" disabled>Valider ‚ñ∂</button>
      </div>
    </div>

    <footer>¬© Eurocast ‚Äì Quiz d'int√©gration interne.</footer>
  </main>

  <div id="certificateModal" role="dialog" aria-modal="true" aria-labelledby="certTitle">
    <div class="cert-dialog">
      <button class="close-cert" id="closeCert" aria-label="Fermer">‚úï</button>
      <div class="cert-emblem">üéì</div>
      <h2 id="certTitle">Certification d'Int√©gration</h2>
      <p>F√©licitations ! Vous avez valid√© le parcours d'int√©gration avec succ√®s.</p>
      <div class="cert-body" id="certBody"></div>
      <button class="download-btn" id="downloadCert">‚¨á T√©l√©charger le certificat (PDF)</button>
    </div>
  </div>

  <script>
    // Banque de questions
    const baseQuestions = [
      { q:"Pourquoi l'authentification multifacteur (MFA) est-elle essentielle ?", answers:["Pour d√©corer l'interface","Pour emp√™cher l'utilisation d'identifiants compromis","Pour acc√©l√©rer l'ordinateur"], correct:1, explain:"Le MFA r√©duit fortement l'exploitation d'un mot de passe compromis en exigeant un second facteur.", module:'m2' },
      { q:"Quels √©l√©ments rendent un ticket GLPI exploitable ?", answers:["Un simple 'URGENT svp'","Description structur√©e + contexte + r√©sultat attendu + capture utile","Uniquement une capture d'√©cran"], correct:1, explain:"Contexte + actions tent√©es + r√©sultat attendu + preuve = diagnostic rapide.", module:'m3' },
      { q:"Que faire face √† un e-mail clairement suspect ?", answers:["Cliquer pour ouvrir les pi√®ces jointes et v√©rifier","Le transf√©rer imm√©diatement au support s√©curit√© sans interagir","R√©pondre pour demander s'il est l√©gitime"], correct:1, explain:"Ne pas interagir : transf√©rer pour analyse pr√©serve les preuves et limite le risque.", module:'m2' },
      { q:"O√π stocker un document interne CONFIDENTIEL ?", answers:["Sur une cl√© USB personnelle 'temporaire'","Dans OneDrive ou un partage s√©curis√© autoris√©","Dans un dossier local non sauvegard√©"], correct:1, explain:"Un stockage approuv√© centralis√© assure sauvegarde et contr√¥le d'acc√®s.", module:'m5' },
      { q:"En d√©placement avec votre PC portable, la meilleure pratique est :", answers:["Le laisser dans la voiture cach√© sous un v√™tement","Le garder toujours sur vous ou sous surveillance directe","Le pr√™ter pour all√©ger le sac"], correct:1, explain:"Un appareil laiss√© sans surveillance est une cible facile. Toujours le conserver sous contr√¥le.", module:'m6' },
      { q:"Mot de passe oubli√© : r√©action conforme ?", answers:["Demander temporairement celui d'un coll√®gue","Utiliser la proc√©dure officielle de r√©initialisation","Cr√©er un compte personnel provisoire"], correct:1, explain:"Seule la proc√©dure officielle maintient tra√ßabilit√© et s√©curit√©.", module:'m2' },
      { q:"But principal de la checklist de fin d'onboarding ?", answers:["Remplacer la supervision informatique","Valider que l'autonomie de base et les acc√®s essentiels sont en place","Ajouter une formalit√© inutile"], correct:1, explain:"Elle confirme que la base op√©rationnelle est pr√™te.", module:'m9' },
      { q:"Concernant l'usage du mat√©riel informatique professionnel :", answers:["Usage personnel illimit√© tant que cela reste discret","Usage strictement professionnel (pas d'usage personnel)","Pr√™t libre √† des proches de confiance"], correct:1, explain:"Le mat√©riel est d√©di√© √† l'activit√© professionnelle uniquement.", module:'m6' },
      { q:"Quel signe doit en priorit√© vous alerter dans un e‚Äëmail qui para√Æt cr√©dible ?", answers:["Adresse d'exp√©dition r√©elle (domaine) l√©g√®rement diff√©rente / alt√©r√©e","Logo officiel en haute r√©solution","Texte soign√© sans fautes"], correct:0, explain:"Le domaine exact de l'exp√©diteur est l'indicateur le plus fiable : un domaine alt√©r√© ou masqu√© malgr√© un contenu soign√© est caract√©ristique d'un phishing √©labor√©. Ex: support@micr0soft-secure.com (0 √† la place du o).", module:'m2' },
      { q:"Avant d'escalader un incident 'critique', il faut :", answers:["V√©rifier l'impact r√©el et collecter les faits","Escalader imm√©diatement sans v√©rification","Attendre pour voir si cela se reproduit"], correct:0, explain:"Qualification factuelle √©vite les fausses alertes et acc√©l√®re la bonne r√©ponse.", module:'m7' },
      { q:"M√©thode la PLUS s√ªre pour partager un fichier sensible interne :", answers:["Pi√®ce jointe non chiffr√©e vers un externe","Lien OneDrive restreint aux destinataires autoris√©s","H√©bergement sur un site public gratuit"], correct:1, explain:"Lien restreint = contr√¥le, r√©vocation et tra√ßabilit√©.", module:'m5' },
      { q:"Quel sc√©nario illustre une tentative de social engineering ?", answers:["Un faux 'technicien' demande un code MFA par t√©l√©phone","Un coll√®gue vous dit bonjour dans le hall","Invitation calendrier interne attendue"], correct:0, explain:"Pr√©texte + demande d'information sensible = manipulation sociale.", module:'m2' },
      { q:"Quel mot de passe respecte le mieux la politique ?", answers:["P@ssw0rd2024","EquationArbreVerre!12","123456789012"], correct:1, explain:"Une phrase longue multi-mots + caract√®re sp√©cial augmente l'entropie.", module:'m2' },
      { q:"SMS MFA re√ßu sans action de votre part :", answers:["L'ignorer et donner le code si on vous appelle","Le signaler (potentielle tentative) et v√©rifier l'activit√©","R√©pondre avec votre identifiant"], correct:1, explain:"Un code non sollicit√© = possible tentative de prise de contr√¥le.", module:'m2' },
      { q:"Poste trouv√© ouvert et d√©verrouill√© sans propri√©taire :", answers:["Regarder quelques mails pour aider","Verrouiller imm√©diatement et signaler si r√©current","Changer le fond d'√©cran pour plaisanter"], correct:1, explain:"S√©curiser l'acc√®s pour √©viter un usage malveillant.", module:'m6' },
      { q:"Quelle prudence appliquer avec l'affichage d'un nom exp√©diteur (alias) ?", answers:["Se fier uniquement au nom affich√© si familier","V√©rifier le domaine r√©el complet de l'adresse exp√©diteur","R√©pondre d'abord puis analyser ensuite"], correct:1, explain:"Le nom (alias) peut √™tre forg√©. Il faut d√©velopper le champ ou survoler pour voir l'adresse r√©elle.", module:'m2' }
    ];

    let index=0; let selected=null; let started=Date.now();
    let finished=false; let timeExpired=false;
    // Shuffle util
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()* (i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
    // Build quiz questions with shuffled order and shuffled answers
    const questions = shuffle(baseQuestions.slice()).map(q=>{
      const answers = q.answers.map((a,i)=>({text:a, correct:i===q.correct}));
      shuffle(answers);
      return { q: q.q, answers, explain:q.explain, module:q.module };
    });
    let answerSelections = new Array(questions.length).fill(null); // stores index chosen

    const qTitle=document.getElementById('questionTitle');
    const qText=document.getElementById('questionText');
    const answersEl=document.getElementById('answers');
    const nextBtn=document.getElementById('nextBtn');
    const prevBtn=document.getElementById('prevBtn');
  const feedback=document.getElementById('feedback'); // non utilis√© d√©sormais (score seulement √† la fin)
    const progressInner=document.getElementById('progressInner');

    const TOTAL_TIME_MS = 15*60*1000; // 15 minutes
    const endTime = started + TOTAL_TIME_MS;
    function formatCountdown(ms){ if(ms<0) ms=0; const s=Math.floor(ms/1000); const m=Math.floor(s/60); const rs=s%60; return `${String(m).padStart(2,'0')}:${String(rs).padStart(2,'0')}`; }
    const timerEl = document.getElementById('timer');
    const timeSpan = document.getElementById('time');
    const tick = ()=>{
      if(finished) return; // stop updates once finished
      const remaining = endTime - Date.now();
      timeSpan.textContent = formatCountdown(remaining);
      if(remaining <= 0){ timeExpired=true; finish(); return; }
      const mins = remaining / 60000;
      timerEl.classList.toggle('danger', mins <= 1.5);
      timerEl.classList.toggle('warning', mins <= 5 && mins > 1.5);
    };
    tick();
    const timerInterval = setInterval(tick,1000);

    function loadQuestion(){
      const q=questions[index];
      qTitle.textContent=`Question ${index+1}/${questions.length}`;
      qText.textContent=q.q;
      answersEl.innerHTML='';
      selected = answerSelections[index];
      feedback.innerHTML='';
      q.answers.forEach((ansObj,i)=>{
        const btn=document.createElement('button');
        btn.className='answer-btn';
        btn.innerHTML=`<span style='flex:1;'>${ansObj.text}</span>`;
        btn.addEventListener('click',()=> selectAnswer(i, btn));
        if(selected === i){ btn.classList.add('active'); }
        answersEl.appendChild(btn);
      });
      prevBtn.disabled = index===0;
      nextBtn.disabled = (selected===null);
      nextBtn.textContent = (index === questions.length-1) ? 'Terminer ‚ñ∂' : (selected!==null ? 'Suivant ‚ñ∂' : 'Valider ‚ñ∂');
      progressInner.style.width=(index/questions.length*100)+'%';
    }

    function selectAnswer(i, btn){
      selected=i; answerSelections[index]=i; answersEl.querySelectorAll('.answer-btn').forEach(b=>{b.classList.remove('active'); b.style.borderColor='';}); btn.classList.add('active'); nextBtn.disabled=false; nextBtn.textContent = (index === questions.length-1) ? 'Terminer ‚ñ∂' : 'Suivant ‚ñ∂';
    }

    nextBtn.addEventListener('click',()=>{
      if(finished) return;
      if(selected===null) return; // ne pas avancer sans choix
      if(index < questions.length-1){ index++; loadQuestion(); }
      else { finish(); }
    });

    prevBtn.addEventListener('click',()=>{
      if(index>0){ index--; loadQuestion(); }
    });

    function finish(){
      if(finished) return; // idempotent
      finished=true;
      progressInner.style.width='100%';
      clearInterval(timerInterval);
      if(answerSelections.length !== questions.length){
        const old = answerSelections.slice();
        answerSelections = new Array(questions.length).fill(null);
        for(let i=0;i<Math.min(old.length,questions.length);i++) answerSelections[i]=old[i];
      }
      const score = answerSelections.reduce((acc, val, i)=> {
        if(val===null) return acc; // unanswered
        const q = questions[i];
        return q.answers[val].correct ? acc+1 : acc;
      }, 0);
      const percent = Math.round(score/questions.length*100);
      openCertificate(percent, score);
      // disable navigation
      nextBtn.disabled=true; prevBtn.disabled=true;
    }

    function openCertificate(pct, rawScore){
      const modal=document.getElementById('certificateModal');
      const body=document.getElementById('certBody');
      const pass = pct>=70;
      const remainingDisplay = timeExpired ? 'Temps √©coul√©' : `Temps utilis√©: ${formatUsedTime()}`;
      body.innerHTML = `
        <div class='cert-title'>${pass? 'Certificat de Validation':'Attestation de Participation'}</div>
        <div class='cert-meta'>Score: ${pct}% (${rawScore}/${questions.length}) ‚Ä¢ ${remainingDisplay}</div>
        ${timeExpired? '<p style="color:#b31217;font-weight:600;">Fin automatique : limite de temps atteinte (15 min).</p>':''}
        <p>Ce document atteste que <strong>${getUserName()}</strong> a ${pass? 'r√©ussi':'compl√©t√©'} le quiz d'int√©gration de base portant sur la s√©curit√©, l\'utilisation des outils, la gestion du mat√©riel et les bonnes pratiques internes.</p>
        <p style='font-size:.7rem;color:#555;'>R√©f√©rence interne: ONB-${Date.now()}</p>`;

      if(pass){
        // construire r√©capitulatif
        let rows = '';
        questions.forEach((q,i)=>{
          const userIdx = answerSelections[i];
          const correctObj = q.answers.find(a=>a.correct);
          const userObj = userIdx!=null ? q.answers[userIdx] : null;
          const ok = userObj && userObj.correct;
          const reviewLink = (!ok && q.module) ? `<br><a href=\"formation_onboarding.html#${q.module}\" style=\"font-size:.6rem;color:#b31217;font-weight:600;text-decoration:none;\">Revoir le module</a>` : '';
          rows += `<tr class=\"${ok?'ok':'ko'}\"><td>${i+1}</td><td>${escapeHtml(q.q)}${reviewLink}</td><td>${userObj?escapeHtml(userObj.text):'<em>Non r√©pondu</em>'}</td><td>${escapeHtml(correctObj.text)}</td></tr>`;
        });
        body.insertAdjacentHTML('beforeend', `
          <h3 style="margin:24px 0 8px;font-size:1rem;color:#b31217;">R√©capitulatif des r√©ponses</h3>
          <div style="overflow:auto;max-height:260px;border:1px solid #e2e6eb;border-radius:12px;">
            <table style="border-collapse:collapse;width:100%;font-size:.65rem;line-height:1.35;">
              <thead><tr style="background:#f5f7fa;"><th style='text-align:left;padding:6px 8px;border-bottom:1px solid #e2e6eb;'>#</th><th style='text-align:left;padding:6px 8px;border-bottom:1px solid #e2e6eb;'>Question</th><th style='text-align:left;padding:6px 8px;border-bottom:1px solid #e2e6eb;'>Votre r√©ponse</th><th style='text-align:left;padding:6px 8px;border-bottom:1px solid #e2e6eb;'>Bonne r√©ponse</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
          <style>
            .cert-dialog table tbody tr.ok {background:linear-gradient(90deg,#e6f7ed,#ffffff);}
            .cert-dialog table tbody tr.ko {background:linear-gradient(90deg,#ffecec,#ffffff);}
            .cert-dialog table tbody td {padding:5px 8px;border-bottom:1px solid #f0f2f4;vertical-align:top;}
            .cert-dialog table tbody tr:last-child td {border-bottom:none;}
          </style>
        `);
      }
      modal.classList.add('active');
    }

    function escapeHtml(str){
      return str.replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));
    }

    function formatUsedTime(){
      const usedMs = Date.now() - started;
      const s=Math.floor(usedMs/1000); const m=Math.floor(s/60); const rs=s%60; return `${String(m).padStart(2,'0')}:${String(rs).padStart(2,'0')}`;
    }

    function getUserName(){
      const stored = localStorage.getItem('onboarding_username');
      if(stored) return stored;
      const name = prompt('Entrez votre Nom Pr√©nom pour le certificat:','');
      if(name) localStorage.setItem('onboarding_username', name);
      return name || 'Utilisateur';
    }

    document.getElementById('closeCert').addEventListener('click',()=>{
      document.getElementById('certificateModal').classList.remove('active');
    });

    document.getElementById('downloadCert').addEventListener('click',()=>{
      const el = document.querySelector('.cert-dialog');
      const w = window.open('', 'PRINT', 'width=900,height=900');
      w.document.write('<html><head><title>Certificat</title><style>body{font-family:Segoe UI, sans-serif;padding:40px;background:#f5f7fa;} .cert{background:#fff;border:2px solid #b31217;border-radius:20px;padding:40px;box-shadow:0 6px 20px rgba(0,0,0,.15);} h1{margin-top:0;color:#b31217;} .meta{font-size:.7rem;color:#555;margin-bottom:14px;} </style></head><body><div class="cert">'+el.querySelector('#certBody').innerHTML+'</div></body></html>');
      w.document.close(); w.focus(); w.print(); w.close();
    });

    loadQuestion();
  </script>
</body>
</html>